{"ast":null,"code":"import \"antd/lib/form/style\";\nimport _Form from \"antd/lib/form\";\nvar __jsx = React.createElement;\nimport React, { useEffect, useState, useInterval } from \"react\";\nimport Webcam from \"react-webcam\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { updateFirstName, updateLastName, updateSsid, updateToken } from \"../../store/actions/postAction\";\nimport Router from \"next/router\";\nimport Axios from \"axios\";\nimport SuggestComponent from './component.suggestion';\nconst FormItem = _Form.Item;\nvar textAlertOne;\nvar textAlertTwo;\n\nconst WebcamCapture = () => {\n  const dispatch = useDispatch();\n  const webcamRef = React.useRef(null);\n  const [imgSrc, setImgSrc] = React.useState(null);\n  const {\n    token\n  } = useSelector(state => state.post);\n  const {\n    0: isLoading,\n    1: setisLoading\n  } = useState(false);\n  const {\n    0: isReadyCapture,\n    1: setisReacyCapture\n  } = useState(10);\n  const {\n    0: check,\n    1: setCheck\n  } = useState(\"block\");\n  const {\n    0: Alert,\n    1: setAlert\n  } = useState('none');\n  useEffect(() => {\n    dispatch(updateToken(localStorage.getItem(\"jwt\")));\n\n    if (localStorage.getItem(\"jwt\")) {\n      setisLoading(true);\n    } else {\n      Router.push(\"/page.covid1\");\n    }\n  }, []);\n  useEffect(() => {\n    if (isReadyCapture === 0) {\n      setAlert('block');\n      textAlertOne = \"กรุณารอสักครู่\";\n      capture();\n    } else {\n      if (isReadyCapture <= 0) {\n        return null;\n      } else {\n        setTimeout(() => {\n          setisReacyCapture(isReadyCapture - 1);\n\n          if (isReadyCapture === 1) {\n            setCheck(\"none\");\n          }\n        }, [1000]);\n      }\n    }\n  }, [isReadyCapture]);\n\n  const Axiosphoto = value => {\n    setAlert('none');\n    const Command = value;\n    console.log(Command);\n\n    if (Command.code === \"111\") {\n      //alert(\"กรุณาถอดหน้ากาก\");\n      textAlertOne = \"กรุณาถอดหน้ากาก\";\n      textAlertTwo = \"จะเริ่มทำการบันทึกภาพใหม่\";\n      setAlert('block');\n      setTimeout(() => {\n        setAlert('none');\n        textAlertOne = \"\";\n        textAlertTwo = \"\";\n        setisReacyCapture(10);\n        setCheck('block');\n      }, [5000]);\n    } else if (Command.code === \"100\") {\n      console.log(Command.code);\n      localStorage.setItem(\"user\", JSON.stringify(value.payload));\n      dispatch(updateSsid(value.payload.cid));\n      dispatch(updateFirstName(value.payload.fisrt_name));\n      dispatch(updateLastName(value.payload.last_name)); //alert(\"พบข้อมูล\");\n\n      textAlertOne = \"พบข้อมูล\";\n      textAlertTwo = \"กำลังไปหน้าต่อไป\";\n      setAlert('block');\n      setTimeout(() => {\n        textAlertOne = \"\";\n        textAlertTwo = \"\";\n        Router.push(\"/page.covid4\");\n      }, [2000]);\n    } else if (Command.code === \"110\") {\n      //alert(\"ไม่พบข้อมูล,กรุณาโชว์บัตรประชาชนแทน\");\n      textAlertOne = \"ไม่พบข้อมูล\";\n      textAlertTwo = \"กรุณาโชว์บัตรประชาชนแทน\";\n      setAlert('block');\n      setTimeout(() => {\n        setAlert('none');\n        textAlertOne = \"\";\n        textAlertTwo = \"\";\n        setisReacyCapture(10);\n        setCheck('block');\n      }, [5000]);\n    }\n  };\n\n  function taskOne() {\n    return new Promise(async resolve => {\n      const A = async () => {\n        const imageSrc = await webcamRef.current.getScreenshot();\n        localStorage.setItem(\"image\", imageSrc);\n        var block = await imageSrc.split(\";\");\n        var contentType = await block[0].split(\":\")[1];\n        var realData = await block[1].split(\",\")[1];\n        var blob = await b64toBlob(realData, contentType);\n        resolve(blob);\n      };\n\n      await A();\n    });\n  }\n\n  function taskTwo(value) {\n    return new Promise(async resolve => {\n      const B = async () => {\n        await console.log(\"A\", value);\n        const formData = await new FormData();\n        await formData.append(\"picture\", value);\n        return formData;\n      };\n\n      const postimage = async () => {\n        console.log('FormData', formData);\n        /*await Axios.post(\r\n          \"https://www.nuscreening.kasemsanm.com/api/v1/faceDetect/1\",\r\n          formData,\r\n          {\r\n            headers: {\r\n              Authorization: `Bearer ${localStorage.getItem(\"jwt\")}`,\r\n              \"Content-Type\": \"multipart/form-data\",\r\n            },\r\n          }\r\n        )\r\n          .then((res) => {\r\n            console.log(\"success\", res.data);\r\n            Axiosphoto(res.data);\r\n          })\r\n          .catch((err) => {\r\n            console.log(\"เตือนไม่พอข้อมูล\", err.response.status);\r\n            if (err.response.status === 401) {\r\n              Axios({\r\n                method: \"GET\",\r\n                url:\r\n                  \"https://www.nuscreening.kasemsanm.com/api/v1/manage/token\",\r\n                headers: {\r\n                  Authorization: `Bearer ${localStorage.getItem(\r\n                    \"jwt-refresh\"\r\n                  )}`,\r\n                },\r\n              })\r\n                .then((res) => {\r\n                  localStorage.setItem(\"jwt\", res.data[\"accessToken\"]);\r\n                  localStorage.setItem(\"jwt-refresh\", res.data[\"refreshToken\"]);\r\n                  dispatch(updateToken(res.data[\"accessToken\"]));\r\n                  console.log(\"Update Token Success!\", res);\r\n                  postimage();\r\n                })\r\n                .catch((error) => {\r\n                  console.log(\"Error Code\", error.response.status);\r\n                  Router.push(\"/page.covid1\");\r\n                });\r\n            }\r\n          });*/\n\n        let data = {\n          \"code\": \"100\",\n          \"payload\": {\n            \"cid\": 3640600077526,\n            \"fisrt_name\": \"Panuwit\",\n            \"last_name\": \"Makmee\"\n          }\n        };\n        Axiosphoto(data);\n      };\n\n      var formData = await B();\n      await postimage();\n    });\n  }\n\n  const main = async () => {\n    var result = await taskOne();\n    await taskTwo(result);\n  };\n\n  const capture = () => {\n    main();\n  };\n  /*const [statee, setStatee] = useState(null);\r\n  const fileSelectedHandler = (event) => {\r\n    setStatee(event.target.files[0]);\r\n    console.log(event.target.files[0]);\r\n  };\r\n  const fileUploadHandler = () => {\r\n    console.log(\"TEST\", statee);\r\n    const fd = new FormData();\r\n    fd.append(\"picture\", statee);\r\n    Axios.post(\"http://34.87.54.114:8003/api/v1/file/uploadphoto\", fd, {\r\n      headers: {\r\n        Authorization: `Bearer ${token}`,\r\n        \"Content-Type\": \"multipart/form-data\",\r\n      },\r\n    })\r\n      .then((res) => {\r\n        console.log(\"success\", res);\r\n      })\r\n      .catch((err) => {\r\n        console.log(\"err\", err);\r\n      });\r\n  };*/\n\n\n  function b64toBlob(b64Data, contentType, sliceSize) {\n    contentType = contentType || \"\";\n    sliceSize = sliceSize || 512;\n    var byteCharacters = atob(b64Data);\n    var byteArrays = [];\n\n    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {\n      var slice = byteCharacters.slice(offset, offset + sliceSize);\n      var byteNumbers = new Array(slice.length);\n\n      for (var i = 0; i < slice.length; i++) {\n        byteNumbers[i] = slice.charCodeAt(i);\n      }\n\n      var byteArray = new Uint8Array(byteNumbers);\n      byteArrays.push(byteArray);\n    }\n\n    var blob = new Blob(byteArrays, {\n      type: contentType\n    });\n    return blob;\n  }\n  /*const test = () => {\r\n    var ImageURL = data;\r\n    console.log(ImageURL);\r\n    var block = ImageURL.split(\";\");\r\n    var contentType = block[0].split(\":\")[1];\r\n    var realData = block[1].split(\",\")[1];\r\n    var blob = b64toBlob(realData, contentType);\r\n    console.log(blob);\r\n    const fd = new FormData();\r\n    fd.append(\"picture\", blob);\r\n    Axios.post(\"http://34.87.54.114:8003/api/v1/file/uploadphoto\", fd, {\r\n      headers: {\r\n        Authorization: `Bearer ${token}`,\r\n        \"Content-Type\": \"multipart/form-data\",\r\n      },\r\n    })\r\n      .then((res) => {\r\n        console.log(\"success\", res);\r\n      })\r\n      .catch((err) => {\r\n        console.log(\"err\", err);\r\n      });\r\n  };*/\n\n\n  if (isLoading) {\n    const keyword = [\"พร้อมถ่าย\"];\n    return __jsx(\"div\", null, __jsx(FormItem, null, __jsx(\"div\", {\n      style: {\n        display: check\n      },\n      className: \"modal\"\n    }, __jsx(\"div\", {\n      className: \"modal-content\"\n    }, __jsx(\"h1\", {\n      style: {\n        fontSize: \"100px\",\n        opacity: \"0.8\"\n      }\n    }, isReadyCapture))), __jsx(\"div\", {\n      style: {\n        display: Alert\n      },\n      className: \"modal cl-modal\"\n    }, __jsx(\"div\", {\n      className: \"modal-content cl-modal-content\"\n    }, __jsx(SuggestComponent, {\n      page: \"snapshot\",\n      textAlertOne: textAlertOne,\n      textAlertTwo: textAlertTwo\n    }))), __jsx(\"div\", null, __jsx(Webcam, {\n      audio: false,\n      ref: webcamRef,\n      screenshotFormat: \"image/jpeg\",\n      style: {\n        borderRadius: \"20px\",\n        color: \"white\"\n      }\n    }))));\n  } else {\n    return null;\n  }\n};\n\nexport default WebcamCapture;","map":null,"metadata":{},"sourceType":"module"}