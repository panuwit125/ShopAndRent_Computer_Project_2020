{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"@babel/runtime/helpers/esm/slicedToArray\";\nimport \"antd/lib/form/style\";\nimport _Form from \"antd/lib/form\";\nvar __jsx = React.createElement;\nimport React, { useEffect, useState, useInterval } from \"react\";\nimport Webcam from \"react-webcam\";\nimport { useDispatch, useSelector } from \"react-redux\";\nimport { updateFirstName, updateLastName, updateSsid, updateToken } from \"../../store/actions/postAction\";\nimport Router from \"next/router\";\nimport Axios from \"axios\";\nimport SuggestComponent from './component.suggestion';\nvar FormItem = _Form.Item;\nvar textAlertOne;\nvar textAlertTwo;\n\nvar WebcamCapture = function WebcamCapture() {\n  var dispatch = useDispatch();\n  var webcamRef = React.useRef(null);\n\n  var _React$useState = React.useState(null),\n      _React$useState2 = _slicedToArray(_React$useState, 2),\n      imgSrc = _React$useState2[0],\n      setImgSrc = _React$useState2[1];\n\n  var _useSelector = useSelector(function (state) {\n    return state.post;\n  }),\n      token = _useSelector.token;\n\n  var _useState = useState(false),\n      isLoading = _useState[0],\n      setisLoading = _useState[1];\n\n  var _useState2 = useState(10),\n      isReadyCapture = _useState2[0],\n      setisReacyCapture = _useState2[1];\n\n  var _useState3 = useState(\"block\"),\n      check = _useState3[0],\n      setCheck = _useState3[1];\n\n  var _useState4 = useState('none'),\n      Alert = _useState4[0],\n      setAlert = _useState4[1];\n\n  useEffect(function () {\n    dispatch(updateToken(localStorage.getItem(\"jwt\")));\n\n    if (localStorage.getItem(\"jwt\")) {\n      setisLoading(true);\n    } else {\n      Router.push(\"/page.covid1\");\n    }\n  }, []);\n  useEffect(function () {\n    if (isReadyCapture === 0) {\n      setAlert('block');\n      textAlertOne = \"กรุณารอสักครู่\";\n      capture();\n    } else {\n      if (isReadyCapture <= 0) {\n        return null;\n      } else {\n        setTimeout(function () {\n          setisReacyCapture(isReadyCapture - 1);\n\n          if (isReadyCapture === 1) {\n            setCheck(\"none\");\n          }\n        }, [1000]);\n      }\n    }\n  }, [isReadyCapture]);\n\n  var Axiosphoto = function Axiosphoto(value) {\n    setAlert('none');\n    var Command = value;\n    console.log(Command);\n\n    if (Command.code === \"111\") {\n      //alert(\"กรุณาถอดหน้ากาก\");\n      textAlertOne = \"กรุณาถอดหน้ากาก\";\n      textAlertTwo = \"จะเริ่มทำการบันทึกภาพใหม่\";\n      setAlert('block');\n      setTimeout(function () {\n        setAlert('none');\n        textAlertOne = \"\";\n        textAlertTwo = \"\";\n        setisReacyCapture(10);\n        setCheck('block');\n      }, [5000]);\n    } else if (Command.code === \"100\") {\n      console.log(Command.code);\n      localStorage.setItem(\"user\", JSON.stringify(value.payload));\n      dispatch(updateSsid(value.payload.cid));\n      dispatch(updateFirstName(value.payload.fisrt_name));\n      dispatch(updateLastName(value.payload.last_name)); //alert(\"พบข้อมูล\");\n\n      textAlertOne = \"พบข้อมูล\";\n      textAlertTwo = \"กำลังไปหน้าต่อไป\";\n      setAlert('block');\n      setTimeout(function () {\n        textAlertOne = \"\";\n        textAlertTwo = \"\";\n        Router.push(\"/page.covid4\");\n      }, [2000]);\n    } else if (Command.code === \"110\") {\n      //alert(\"ไม่พบข้อมูล,กรุณาโชว์บัตรประชาชนแทน\");\n      textAlertOne = \"ไม่พบข้อมูล\";\n      textAlertTwo = \"กรุณาโชว์บัตรประชาชนแทน\";\n      setAlert('block');\n      setTimeout(function () {\n        setAlert('none');\n        textAlertOne = \"\";\n        textAlertTwo = \"\";\n        setisReacyCapture(10);\n        setCheck('block');\n      }, [5000]);\n    }\n  };\n\n  function taskOne() {\n    return new Promise( /*#__PURE__*/function () {\n      var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(resolve) {\n        var A;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                A = /*#__PURE__*/function () {\n                  var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n                    var imageSrc, block, contentType, realData, blob;\n                    return _regeneratorRuntime.wrap(function _callee$(_context) {\n                      while (1) {\n                        switch (_context.prev = _context.next) {\n                          case 0:\n                            _context.next = 2;\n                            return webcamRef.current.getScreenshot();\n\n                          case 2:\n                            imageSrc = _context.sent;\n                            localStorage.setItem(\"image\", imageSrc);\n                            _context.next = 6;\n                            return imageSrc.split(\";\");\n\n                          case 6:\n                            block = _context.sent;\n                            _context.next = 9;\n                            return block[0].split(\":\")[1];\n\n                          case 9:\n                            contentType = _context.sent;\n                            _context.next = 12;\n                            return block[1].split(\",\")[1];\n\n                          case 12:\n                            realData = _context.sent;\n                            _context.next = 15;\n                            return b64toBlob(realData, contentType);\n\n                          case 15:\n                            blob = _context.sent;\n                            resolve(blob);\n\n                          case 17:\n                          case \"end\":\n                            return _context.stop();\n                        }\n                      }\n                    }, _callee);\n                  }));\n\n                  return function A() {\n                    return _ref2.apply(this, arguments);\n                  };\n                }();\n\n                _context2.next = 3;\n                return A();\n\n              case 3:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2);\n      }));\n\n      return function (_x) {\n        return _ref.apply(this, arguments);\n      };\n    }());\n  }\n\n  function taskTwo(value) {\n    return new Promise( /*#__PURE__*/function () {\n      var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee5(resolve) {\n        var B, postimage, formData;\n        return _regeneratorRuntime.wrap(function _callee5$(_context5) {\n          while (1) {\n            switch (_context5.prev = _context5.next) {\n              case 0:\n                B = /*#__PURE__*/function () {\n                  var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n                    var formData;\n                    return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n                      while (1) {\n                        switch (_context3.prev = _context3.next) {\n                          case 0:\n                            _context3.next = 2;\n                            return console.log(\"A\", value);\n\n                          case 2:\n                            _context3.next = 4;\n                            return new FormData();\n\n                          case 4:\n                            formData = _context3.sent;\n                            _context3.next = 7;\n                            return formData.append(\"picture\", value);\n\n                          case 7:\n                            return _context3.abrupt(\"return\", formData);\n\n                          case 8:\n                          case \"end\":\n                            return _context3.stop();\n                        }\n                      }\n                    }, _callee3);\n                  }));\n\n                  return function B() {\n                    return _ref4.apply(this, arguments);\n                  };\n                }();\n\n                postimage = /*#__PURE__*/function () {\n                  var _ref5 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n                    var data;\n                    return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n                      while (1) {\n                        switch (_context4.prev = _context4.next) {\n                          case 0:\n                            console.log('FormData', formData);\n                            /*await Axios.post(\r\n                              \"https://www.nuscreening.kasemsanm.com/api/v1/faceDetect/1\",\r\n                              formData,\r\n                              {\r\n                                headers: {\r\n                                  Authorization: `Bearer ${localStorage.getItem(\"jwt\")}`,\r\n                                  \"Content-Type\": \"multipart/form-data\",\r\n                                },\r\n                              }\r\n                            )\r\n                              .then((res) => {\r\n                                console.log(\"success\", res.data);\r\n                                Axiosphoto(res.data);\r\n                              })\r\n                              .catch((err) => {\r\n                                console.log(\"เตือนไม่พอข้อมูล\", err.response.status);\r\n                                if (err.response.status === 401) {\r\n                                  Axios({\r\n                                    method: \"GET\",\r\n                                    url:\r\n                                      \"https://www.nuscreening.kasemsanm.com/api/v1/manage/token\",\r\n                                    headers: {\r\n                                      Authorization: `Bearer ${localStorage.getItem(\r\n                                        \"jwt-refresh\"\r\n                                      )}`,\r\n                                    },\r\n                                  })\r\n                                    .then((res) => {\r\n                                      localStorage.setItem(\"jwt\", res.data[\"accessToken\"]);\r\n                                      localStorage.setItem(\"jwt-refresh\", res.data[\"refreshToken\"]);\r\n                                      dispatch(updateToken(res.data[\"accessToken\"]));\r\n                                      console.log(\"Update Token Success!\", res);\r\n                                      postimage();\r\n                                    })\r\n                                    .catch((error) => {\r\n                                      console.log(\"Error Code\", error.response.status);\r\n                                      Router.push(\"/page.covid1\");\r\n                                    });\r\n                                }\r\n                              });*/\n\n                            data = {\n                              \"code\": \"100\",\n                              \"payload\": {\n                                \"cid\": 3640600077526,\n                                \"fisrt_name\": \"Panuwit\",\n                                \"last_name\": \"Makmee\"\n                              }\n                            };\n                            Axiosphoto(data);\n\n                          case 3:\n                          case \"end\":\n                            return _context4.stop();\n                        }\n                      }\n                    }, _callee4);\n                  }));\n\n                  return function postimage() {\n                    return _ref5.apply(this, arguments);\n                  };\n                }();\n\n                _context5.next = 4;\n                return B();\n\n              case 4:\n                formData = _context5.sent;\n                _context5.next = 7;\n                return postimage();\n\n              case 7:\n              case \"end\":\n                return _context5.stop();\n            }\n          }\n        }, _callee5);\n      }));\n\n      return function (_x2) {\n        return _ref3.apply(this, arguments);\n      };\n    }());\n  }\n\n  var main = /*#__PURE__*/function () {\n    var _ref6 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee6() {\n      var result;\n      return _regeneratorRuntime.wrap(function _callee6$(_context6) {\n        while (1) {\n          switch (_context6.prev = _context6.next) {\n            case 0:\n              _context6.next = 2;\n              return taskOne();\n\n            case 2:\n              result = _context6.sent;\n              _context6.next = 5;\n              return taskTwo(result);\n\n            case 5:\n            case \"end\":\n              return _context6.stop();\n          }\n        }\n      }, _callee6);\n    }));\n\n    return function main() {\n      return _ref6.apply(this, arguments);\n    };\n  }();\n\n  var capture = function capture() {\n    main();\n  };\n  /*const [statee, setStatee] = useState(null);\r\n  const fileSelectedHandler = (event) => {\r\n    setStatee(event.target.files[0]);\r\n    console.log(event.target.files[0]);\r\n  };\r\n  const fileUploadHandler = () => {\r\n    console.log(\"TEST\", statee);\r\n    const fd = new FormData();\r\n    fd.append(\"picture\", statee);\r\n    Axios.post(\"http://34.87.54.114:8003/api/v1/file/uploadphoto\", fd, {\r\n      headers: {\r\n        Authorization: `Bearer ${token}`,\r\n        \"Content-Type\": \"multipart/form-data\",\r\n      },\r\n    })\r\n      .then((res) => {\r\n        console.log(\"success\", res);\r\n      })\r\n      .catch((err) => {\r\n        console.log(\"err\", err);\r\n      });\r\n  };*/\n\n\n  function b64toBlob(b64Data, contentType, sliceSize) {\n    contentType = contentType || \"\";\n    sliceSize = sliceSize || 512;\n    var byteCharacters = atob(b64Data);\n    var byteArrays = [];\n\n    for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {\n      var slice = byteCharacters.slice(offset, offset + sliceSize);\n      var byteNumbers = new Array(slice.length);\n\n      for (var i = 0; i < slice.length; i++) {\n        byteNumbers[i] = slice.charCodeAt(i);\n      }\n\n      var byteArray = new Uint8Array(byteNumbers);\n      byteArrays.push(byteArray);\n    }\n\n    var blob = new Blob(byteArrays, {\n      type: contentType\n    });\n    return blob;\n  }\n  /*const test = () => {\r\n    var ImageURL = data;\r\n    console.log(ImageURL);\r\n    var block = ImageURL.split(\";\");\r\n    var contentType = block[0].split(\":\")[1];\r\n    var realData = block[1].split(\",\")[1];\r\n    var blob = b64toBlob(realData, contentType);\r\n    console.log(blob);\r\n    const fd = new FormData();\r\n    fd.append(\"picture\", blob);\r\n    Axios.post(\"http://34.87.54.114:8003/api/v1/file/uploadphoto\", fd, {\r\n      headers: {\r\n        Authorization: `Bearer ${token}`,\r\n        \"Content-Type\": \"multipart/form-data\",\r\n      },\r\n    })\r\n      .then((res) => {\r\n        console.log(\"success\", res);\r\n      })\r\n      .catch((err) => {\r\n        console.log(\"err\", err);\r\n      });\r\n  };*/\n\n\n  if (isLoading) {\n    var keyword = [\"พร้อมถ่าย\"];\n    return __jsx(\"div\", null, __jsx(FormItem, null, __jsx(\"div\", {\n      style: {\n        display: check\n      },\n      className: \"modal\"\n    }, __jsx(\"div\", {\n      className: \"modal-content\"\n    }, __jsx(\"h1\", {\n      style: {\n        fontSize: \"100px\",\n        opacity: \"0.8\"\n      }\n    }, isReadyCapture))), __jsx(\"div\", {\n      style: {\n        display: Alert\n      },\n      className: \"modal cl-modal\"\n    }, __jsx(\"div\", {\n      className: \"modal-content cl-modal-content\"\n    }, __jsx(SuggestComponent, {\n      page: \"snapshot\",\n      textAlertOne: textAlertOne,\n      textAlertTwo: textAlertTwo\n    }))), __jsx(\"div\", null, __jsx(Webcam, {\n      audio: false,\n      ref: webcamRef,\n      screenshotFormat: \"image/jpeg\",\n      style: {\n        borderRadius: \"20px\",\n        color: \"white\"\n      }\n    }))));\n  } else {\n    return null;\n  }\n};\n\nexport default WebcamCapture;","map":null,"metadata":{},"sourceType":"module"}